name: Deploy to VPS

on:
  push:
    branches:
      - main
      - dev

env:
  NODE_VERSION: 18.20.4
  PROD_DEPLOY_PATH: /root/repo/topestka
  DEV_DEPLOY_PATH: /root/repo/dev-topestka

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Set matrix
        id: set-matrix
        run: |
          if [[ "$GITHUB_REF" == "refs/heads/main" ]]; then
            echo "matrix={\"include\":[{\"environment\":\"prod\"}]}" >> $GITHUB_OUTPUT
          else
            echo "matrix={\"include\":[{\"environment\":\"dev\"}]}" >> $GITHUB_OUTPUT
          fi

  build:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    environment: ${{ matrix.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: |
          echo "KURS_ENABLED: ${{ vars.KURS_ENABLED }}" >> .env
          npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.environment }}
          include-hidden-files: true
          path: |
            .next
            .env
            package*.json
            public

  deploy:
    needs: [prepare, build]
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-${{ matrix.environment }}

      - name: Deploy to VPS
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          # Install SSH key
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Add host to known hosts
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

          # Determine deployment path and PM2 process name based on environment
          if [[ "${{ matrix.environment }}" == "prod" ]]; then
            DEPLOY_PATH=$PROD_DEPLOY_PATH
            PM2_NAME="topestka-prod"
          else
            DEPLOY_PATH=$DEV_DEPLOY_PATH
            PM2_NAME="topestka-dev"
          fi

          # Create a temporary directory for the build
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST "mkdir -p $DEPLOY_PATH.tmp"

          # Copy the build files
          scp -i ~/.ssh/deploy_key -r .next package*.json public .env $SSH_USER@$SSH_HOST:$DEPLOY_PATH.tmp/

          # Install production dependencies and restart PM2 with NVM initialized
          ssh -i ~/.ssh/deploy_key $SSH_USER@$SSH_HOST "
            # Load NVM
            export NVM_DIR=\"\$HOME/.nvm\"
            [ -s \"\$NVM_DIR/nvm.sh\" ] && \. \"\$NVM_DIR/nvm.sh\"

            # Use the correct Node version
            nvm use $NODE_VERSION

            # Install dependencies and handle deployment
            cd $DEPLOY_PATH.tmp && npm ci --production

            # Swap directories
            if [ -d $DEPLOY_PATH ]; then rm -rf $DEPLOY_PATH.old; fi
            if [ -d $DEPLOY_PATH ]; then mv $DEPLOY_PATH $DEPLOY_PATH.old; fi
            mv $DEPLOY_PATH.tmp $DEPLOY_PATH

            # Restart or start PM2
            cd /root/repo

            pm2 start ecosystem.config.js --only $PM2_NAME
          "
